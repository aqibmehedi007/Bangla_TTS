<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuteVoice - Bengali Dataset Recorder</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Bengali:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Noto Sans Bengali', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #search-box {
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        #folder-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .folder-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .folder-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .folder-info {
            display: flex;
            flex-direction: column;
        }

        .folder-id {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.recorded {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            overflow-y: auto;
        }

        .transcript-container {
            background: var(--bg-card);
            padding: 48px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            text-align: center;
            margin-bottom: 32px;
            border: 1px solid var(--border);
            position: relative;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .folder-label {
            position: absolute;
            top: 24px;
            left: 24px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        #transcript-text {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.4;
            color: white;
            transition: opacity 0.3s;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .btn-group {
            display: flex;
            gap: 16px;
        }

        button {
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-record {
            background: var(--danger);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-record.recording {
            animation: pulse-red 1.5s infinite;
        }

        .btn-stop {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: white;
        }

        .btn-save {
            background: var(--success);
            color: white;
        }

        .btn-next {
            background: var(--primary);
            color: white;
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* Visualizer */
        .visualizer-container {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .audio-player-container {
            width: 100%;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            display: none;
        }

        audio {
            width: 100%;
            height: 40px;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Progress Bar */
        .progress-wrapper {
            margin-top: auto;
            padding: 24px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Dataset Recorder</h1>
            <input type="text" id="search-box" placeholder="Search ID (e.g. 0001)...">
        </div>
        <div id="folder-list">
            <!-- Folders will be loaded here -->
        </div>
        <div class="progress-wrapper">
            <div class="progress-info">
                <span>Progress</span>
                <span id="progress-text">0/500</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="transcript-container">
            <div class="folder-label" id="current-folder-label">Folder ID: --</div>
            <div id="transcript-text">Select a folder to start...</div>
        </div>

        <div class="visualizer-container">
            <canvas id="visualizer"></canvas>
        </div>

        <div class="controls">
            <div class="btn-group">
                <button id="record-btn" class="btn-record">
                    <span class="icon">●</span> Record
                </button>
                <button id="stop-btn" class="btn-stop" disabled>
                    <span class="icon">■</span> Stop
                </button>
            </div>

            <div class="audio-player-container" id="player-container">
                <audio id="audio-player" controls></audio>
            </div>

            <div class="btn-group">
                <button id="save-btn" class="btn-save" disabled>
                    <span class="icon">✓</span> Save Recording
                </button>
                <button id="next-btn" class="btn-next">
                    Next Sentence →
                </button>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let currentFolderId = null;
        let folders = [];
        let audioContext;
        let analyser;
        let dataArray;
        let animationId;

        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const saveBtn = document.getElementById('save-btn');
        const nextBtn = document.getElementById('next-btn');
        const searchBox = document.getElementById('search-box');
        const transcriptText = document.getElementById('transcript-text');
        const folderLabel = document.getElementById('current-folder-label');
        const folderListEl = document.getElementById('folder-list');
        const audioPlayer = document.getElementById('audio-player');
        const playerContainer = document.getElementById('player-container');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // Initial Load
        async function loadStatus() {
            const res = await fetch('/api/recorder/status');
            const data = await res.json();
            folders = data.folders;
            renderFolderList();
            updateProgress();
        }

        function renderFolderList() {
            const search = searchBox.value.toLowerCase();
            folderListEl.innerHTML = '';

            folders.forEach(folder => {
                if (folder.id.toLowerCase().includes(search)) {
                    const div = document.createElement('div');
                    div.className = `folder-item ${currentFolderId === folder.id ? 'active' : ''}`;
                    div.innerHTML = `
                        <div class="folder-info">
                            <span class="folder-id">${folder.id}</span>
                        </div>
                        <div class="status-dot ${folder.recorded ? 'recorded' : ''}"></div>
                    `;
                    div.onclick = () => selectFolder(folder.id);
                    folderListEl.appendChild(div);
                }
            });
        }

        async function selectFolder(id) {
            currentFolderId = id;
            folderLabel.textContent = `Folder ID: ${id}`;
            transcriptText.style.opacity = '0';

            const res = await fetch(`/api/recorder/transcript/${id}`);
            const data = await res.json();

            setTimeout(() => {
                transcriptText.textContent = data.transcript;
                transcriptText.style.opacity = '1';
            }, 200);

            // Hide player and reset buttons
            playerContainer.style.display = 'none';
            saveBtn.disabled = true;

            // Check if audio exists
            const listFolder = folders.find(f => f.id === id);
            if (listFolder && listFolder.recorded) {
                audioPlayer.src = `/api/recorder/audio/${id}?t=${Date.now()}`;
                playerContainer.style.display = 'block';
            }

            renderFolderList();
        }

        function updateProgress() {
            const recorded = folders.filter(f => f.recorded).length;
            const total = folders.length;
            const percent = (recorded / total) * 100;

            document.getElementById('progress-text').textContent = `${recorded}/${total}`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        searchBox.oninput = renderFolderList;

        // Recording Logic
        recordBtn.onclick = async () => {
            if (!currentFolderId) return alert('Select a folder first!');

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                playerContainer.style.display = 'block';
                saveBtn.disabled = false;

                // Stop visualization
                cancelAnimationFrame(animationId);
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            };

            mediaRecorder.start();
            recordBtn.classList.add('recording');
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            saveBtn.disabled = true;

            startVisualizer(stream);
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            recordBtn.classList.remove('recording');
            recordBtn.disabled = false;
            stopBtn.disabled = true;
        };

        saveBtn.onclick = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            saveBtn.disabled = true;
            saveBtn.textContent = 'Uploading...';

            const res = await fetch(`/api/recorder/upload/${currentFolderId}`, {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                const folder = folders.find(f => f.id === currentFolderId);
                if (folder) folder.recorded = true;

                saveBtn.textContent = '✓ Saved!';
                setTimeout(() => {
                    saveBtn.textContent = '✓ Save Recording';
                    updateProgress();
                    renderFolderList();
                }, 1000);
            } else {
                alert('Failed to upload audio');
                saveBtn.disabled = false;
                saveBtn.textContent = '✓ Save Recording';
            }
        };

        nextBtn.onclick = () => {
            if (!currentFolderId) {
                if (folders.length > 0) selectFolder(folders[0].id);
                return;
            }

            const currentIndex = folders.findIndex(f => f.id === currentFolderId);
            if (currentIndex < folders.length - 1) {
                selectFolder(folders[currentIndex + 1].id);
            }
        };

        // Visualizer
        function startVisualizer(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);

            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            function draw() {
                animationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                canvasCtx.fillStyle = 'rgba(15, 23, 42, 0.2)';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2;
                    const r = 99 + (i * 2);
                    const g = 102 + (i * 1);
                    const b = 241;

                    canvasCtx.fillStyle = `rgb(${r},${g},${b})`;
                    canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        // Keyboard shortcuts
        window.onkeydown = (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (recordBtn.disabled && !stopBtn.disabled) {
                    stopBtn.click();
                } else if (!recordBtn.disabled) {
                    recordBtn.click();
                }
            }
            if (e.code === 'Enter' && !saveBtn.disabled) {
                saveBtn.click();
            }
            if (e.code === 'ArrowRight') {
                nextBtn.click();
            }
        };

        loadStatus();
    </script>
</body>

</html>